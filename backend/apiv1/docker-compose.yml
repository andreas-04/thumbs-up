services:
  server:
    build:
      context: ..
      dockerfile: api/server/Dockerfile
    image: secure-nas-server
    container_name: secure-nas-server
    hostname: thumbsup-server
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN  # Required for mount/umount operations
    # Ports exposed internally via nas-network (not needed on host for container-to-container communication)
    # Uncomment if you want to test mTLS/NFS from your host machine or access via browser:
    ports:
      - "8443:8443"     # mTLS authentication port
      - "8080:8080"     # Web API port (browser access - no installation needed!)
      - "2049:2049"     # NFS port
      - "111:111"       # RPC portmapper
      - "111:111/udp"   # RPC portmapper UDP
      - "20048:20048"   # NFS mountd
    volumes:
      # Use a named volume for NFS exports (NFS requires a real filesystem, not overlay)
      - nfs-storage:/app/demo_storage
    networks:
      - nas-network
    restart: no

  client:
    build:
      context: ..
      dockerfile: api/client/Dockerfile
    image: secure-nas-client
    container_name: secure-nas-client
    cap_add:
      - SYS_ADMIN  # Required for NFS mount operations
    depends_on:
      - server
    networks:
      - nas-network
    stdin_open: true
    tty: true
    # Use startup script with NO hostname - forces mDNS discovery
    command: /app/entrypoint.sh
    profiles:
      - client  # Only start when explicitly requested

networks:
  nas-network:
    driver: bridge

volumes:
  # Named volume for NFS storage - provides a real filesystem that NFS can export
  nfs-storage:
    driver: local
