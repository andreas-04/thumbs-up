sequenceDiagram
    participant C as Client
    participant S as Server
    participant CA as Certificate Authority
    participant FW as Firewall
    participant ST as Storage
    
    Note over C,S: mTLS Handshake
    C->>S: ClientHello + Client Certificate
    S->>CA: Validate Client Certificate
    CA-->>S: Certificate Valid ✓
    S->>C: ServerHello + Server Certificate
    C->>CA: Validate Server Certificate
    CA-->>C: Certificate Valid ✓
    
    Note over C,S: Mutual Authentication Success
    
    S->>S: Extract Client IP Address & Common Name
    S->>FW: Add firewall rule to allow client IP to NFS port
    S->>ST: Check if storage is already mounted
    
    alt First Client Connection
        S->>ST: Unlock encrypted LUKS volume
        S->>ST: Mount encrypted storage to filesystem
    end
    
    S->>S: Add client IP to NFS export table
    S->>S: Refresh NFS exports configuration
    
    S-->>C: Connection Established + NFS Mount Info
    
    C->>S: Request NFS Mount
    S-->>C: NFS Mount Granted
    
    Note over C,S: File Operations
    C->>S: Read/Write Files
    S->>S: Log All File Access Events
    
    C->>S: Client Disconnects
    S->>FW: Remove firewall rule for client IP
    S->>S: Remove client IP from NFS export table
    S->>S: Refresh NFS exports configuration
    
    alt Last Client Disconnected
        S->>S: Start inactivity timeout (60 seconds)
        Note over S: Waiting for new connections...
        S->>ST: Unmount encrypted storage
        S->>ST: Lock LUKS volume
        S->>S: Stop mDNS broadcast, return to DORMANT state
    end