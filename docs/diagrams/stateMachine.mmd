graph TB
    subgraph "Secure NAS Device"
        Button[Physical Button/Trigger]
        StateMachine[State Machine Controller]
        
        subgraph "State: DORMANT"
            D1[All services stopped]
            D2[Storage locked]
        end
        
        subgraph "State: ADVERTISING"
            A1[Avahi Daemon]
            A2[mTLS Listener:8443]
            A3[Storage locked]
        end
        
        subgraph "State: ACTIVE"
            AC1[mTLS Auth Handler]
            AC2[LUKS Manager]
            AC3[NFS Server]
            AC4[Firewall Manager]
            AC5[Activity Monitor]
            AC6[Access Logger]
        end
        
        Storage[(Encrypted Storage<br/>LUKS Volume)]
    end
    
    subgraph "Network"
        mDNS[mDNS/Avahi<br/>Service Discovery]
        
        Client1[Client 1<br/>Valid Cert]
        Client2[Client 2<br/>Valid Cert]
        Client3[Attacker<br/>No Valid Cert]
    end
    
    Button -->|Activate| StateMachine
    StateMachine -->|Transition| D1
    StateMachine -->|Transition| A1
    StateMachine -->|Transition| AC1
    
    A1 -->|Broadcast| mDNS
    mDNS -.->|Discover| Client1
    mDNS -.->|Discover| Client2
    mDNS -.->|Discover| Client3
    
    Client1 -->|Connect| A2
    Client2 -->|Connect| A2
    Client3 -->|Connect| A2
    
    A2 -->|Auth Success| AC1
    A2 -.->|Auth Fail| Client3
    
    AC1 -->|First Client| AC2
    AC2 -->|Unlock| Storage
    Storage -->|Mount| AC3
    
    AC1 -->|Client IP| AC4
    AC4 -->|iptables rule| AC3
    AC3 -->|NFS export| Client1
    AC3 -->|NFS export| Client2
    
    AC3 -->|Access events| AC6
    AC1 -->|Auth events| AC6
    AC5 -->|Monitor| AC3
    AC5 -->|Timeout| StateMachine
    
    style Client3 fill:#ffcccc
    style D2 fill:#ffcccc
    style A3 fill:#ffcccc
    style Storage fill:#ffffcc
    style AC6 fill:#ccffcc